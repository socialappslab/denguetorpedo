

<!-- Modal -->
<div class="modal fade" id="asignar-popup" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">lg</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
                <!-- body-->

                <%= form_tag assignments_post_organizations_url, method: :post, style: "padding: 2rem" do %>
                <div class="form-group">
                    <div class="input-group date" id="datetimepicker">
                        <input type="text" class="form-control" name="date" id="date" required>
                        <span class="input-group-addon">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label> La manzana a recorrer</label>
                    <br />
                    <div id="block-title" class="btn btn-primary">AAAAA</div>
                    <hr />
                    <input id="block-data" type="hidden" name="block" /> 
                    <!--<%= select_tag "block", options_from_collection_for_select(@city_blocks, :id, :name), class: "form-control" %>-->
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select name="status" id="status" class="form-control">
                        <option value="pendiente">Pendiente</option>
                        <option value="realizado">Realizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Actividad a realizar</label>
                    <input type="text" class="form-control" id="task" name="task" required>
                </div>
                <div class="form-group">
                    <label>Voluntarios</label>
                    <input type="text" class="form-control" id="volunteers" name="volunteers" data-role="tagsinput" required>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea class="form-control" id="notes" name="notes"></textarea>
                </div>
                <input type="hidden" name="assignment_id" id="assignment_id">
                <button class="btn btn-default" type="reset" id="cancelar-asignar" style="display:none">Cancelar</button>
                <button class="btn btn-success" id="editar-asignar" style="display:none">Editar asignación</button>
                <button class="btn btn-success" id="guardar-asignar">Asignar</button>
            <% end %>

                <!-- body-->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="list-popup" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">lg</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
                <!-- body-->
                <table class="table">
                    <thead>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="assignment-container">
                    </tbody>
                </table>           

                <!-- body-->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
             
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="message-popup" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">sm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
                <!-- body-->
               <h4> La manzana no cuenta con asignaciones</h4>          

                <!-- body-->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
             
            </div>
        </div>
    </div>
</div>







<div class="container" id="assignments-page">
    <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <%= flash[:notice] %>
    </div>
    <% end %>
    <% if flash[:error] %>    
    <div class="alert alert-danger alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <%= flash[:error] %>
    </div>
    <% end %>
    <div class="row">
        <div class="col-md-12">
            <div id= "select_city" class="form-group">
                <label>Seleccione una ciudad</label>
                <%= select_tag "id_city", options_from_collection_for_select(@all_cities, :id, :name, @city.id) ,class: "form-control"%>    
           </div> 
           <div id= "barrios_select" class="form-group">
                <label>Seleccione el barrio</label>
                <%= select_tag "id_barrio", content_tag(:option,'',:value=>"0-0"), class: "form-control"%>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onClick="load_neighborhood(document.getElementById('id_barrio').value,1)" > 
                
                <div class="row">
                    <div  class="col-md-4">
                    <i style="color:green;" class="fa fa-map-marker"></i><br/>
                    Viejo</div>
                    <div class="col-md-4"> <i style="color:yellow;" class="fa fa-map-marker"></i><br/>Medio</div>
                    <div class="col-md-4"> <i style="color:red;" class="fa fa-map-marker"></i><br/>Reciente</div>
                </div>
                <div class="row">
                    <div class="col-md-12">Lapso de <strong>ultima visita</strong></div>
               
                </div>
                </button> 
                <button class="btn btn-primary" onClick="load_neighborhood(document.getElementById('id_barrio').value,2)"> 
                <div class="row">
                <div class="col-md-4">
                <i style="color:green;" class="fa fa-map-marker"></i><br/>
                Menor</div>
                <div class="col-md-4"> <i style="color:yellow;" class="fa fa-map-marker"></i><br/>Medio</div>
                <div class="col-md-4"> <i style="color:red;" class="fa fa-map-marker"></i><br/>Mayor</div>
            </div>
            <div class="row">
                <div class="col-md-12">Cantidad de <strong>Visitas</strong></div>
           
            </div>
                </button>
               
            </div>
        
       </div>
        <div class="col-md-12">
            <div class="panel panel-default" id="citymap">
                <div id="mapid"></div>
            </div>
        </div>
    </div>
   
                                <h2>Recorridos de hoy</h2>
                                <table class="table">
                                    <thead>
                                        <tr>
                                        <th>Estado</th>    
                                        <th>Manzana</th>
                                        <th>Fecha</th>
                                            
                                        <th>&nbsp;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <% for @item in @assignments %>
                                        <tr>
                                        <td><%= @item.status %></td>
                                        <td><%= @item.city_block.name %></td>

                                        <td><%= @item.created_at %></td>
                                        <td><%= @item.users.count %>
                                        <% for @user in @item.users %>
                                        <%= @user.username %> 
                                        <% end %>
                                        </td>
                                        </tr>
                                    <% end %>


                                    </tbody>
                                </table>
                          
</div>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
    integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
    crossorigin=""></script>

<script>

function load_neighborhood(neighborhood_id, type){
    console.log(neighborhood_id)
    console.log(type)
    let xhr = new XMLHttpRequest();
    xhr.open('GET', '/organizations/mapcityblock/'+neighborhood_id);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'json';
    xhr.onload = function() {
        if (xhr.status !== 200) return
        //data = JSON.parse();

        var max_diff = 0;
         for (let i = 0; i < xhr.response.length; i++) {
            const element = xhr.response[i];
            if(type ==1 ){
                var date =new Date(element.max)
                var date2 = new Date(element.max_group)
                console.log(date);
                console.log(date2);
    
                if(max_diff < ( date.getTime()-date2.getTime())) {
                    max_diff = date.getTime()-date2.getTime();
                }
            }else{
                if( type ==2 ){
                    if( max_diff < element.count){
                        max_diff = element.count 
                    }
                }

            }
           

        }


        for (let i = 0; i < xhr.response.length; i++) {
            const element = xhr.response[i];
                
            if ( element.polygon != null) {
                
                L.geoJSON(JSON.parse(element.polygon),
            {

                style: function (feature) {

                    if(type ==  1){
                        var date =new Date(element.max)
                        var date2 = new Date(element.max_group)
                        fill = perc2color(date.getTime()-date2.getTime(),max_diff)
                    }else{
                        if(type ==2){
                            fill = perc2color(element.count,max_diff)
                        }
                    }
        
                    
                    return {
                        fillColor: fill,
                        weight: 2,
                        opacity: 1,
                        color: 'white',  //Outline color
                        fillOpacity: 0.7
                    };
                },

                onEachFeature:function (feature, layer) {   
                    layer.addEventListener('click', function (event) {

                        // If the clicked element doesn't have the right selector, bail
                    

                        // Don't follow the link
            
                        let request_city_block = new XMLHttpRequest();
                    request_city_block.open('GET', '/organizations/cityblockinfo/'+element.name);
                    request_city_block.setRequestHeader('Content-Type', 'application/json');
                    request_city_block.responseType = 'json';
                    request_city_block.onload = function() {
                        if (request_city_block.status !== 200) return

                            layer.bindPopup("<h3>ID: "+request_city_block.response.obj.name+"</h3> \
                            <p> Cantidad de casas:"+request_city_block.response.count_locations+"</p> \
                            <p> Cantidad de criaderos:"+request_city_block.response.count_inspection+"</p> \
                            <p> Cantidad de visitas :"+request_city_block.response.count_visit+"</p> \
                            <p> Ultima visita :"+request_city_block.response.last_visit_date+"</p> \
                            <button class='btn btn-primary' onclick='abrir_asignar_popup("+request_city_block.response.obj.id+","+request_city_block.response.obj.name+")'>Asignar</button>\
                            <button class='btn btn-primary' onclick='mostrar_asignaciones_popup("+request_city_block.response.obj.id+","+request_city_block.response.obj.name+")'>Ver asignaciones</button> ");
                    
                    };
                    request_city_block.send();

                        // Log the clicked element in the console
                        console.log(event.target);

                        }, false);    

                },

            }
            ).addTo(mymap);
            }
            
            
        }


    
    };
    xhr.send();
}





// the map bind with the div, in a specific lat and long
 
var mymap = L.map('mapid').setView([-25.320044882648016, -57.64547824859619], 18);


// this map use a OpenStreetMap tiles as the first layer 

L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png ', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,

}).addTo(mymap);






    $(document).ready(function() {
        $("#datetimepicker").datetimepicker({
            useCurrent: true,
            icons: {
                time: 'fa fa-clock-o',
                date: 'fa fa-calendar',
                up: 'fa fa-chevron-up',
                down: 'fa fa-chevron-down',
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash'
            }
        });
    });
</script>
<script>

$(document).ready(function() {
    var volunteers = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: '<%= volunteers_json_organizations_url(city_id: @city.id, format: :json) %>'
    });
    volunteers.initialize();
    var elt = $('#volunteers');
    elt.tagsinput({
        itemValue: 'id',
        itemText: 'name',
        typeaheadjs: {
            name: 'volunteers',
            displayKey: 'name',
            source: volunteers.ttAdapter()
        }
    });
})
</script>
<script>
$(document).ready(function() {
    $(".edit-assignment").on("click", function() {
        disableFields();
        var assignmentId = parseInt($(this).data("assignment"));
        $.get("/organizations/assignment/"+assignmentId+".json", function(data) {
            emptyFields();
            $("#editar-asignar").show();
            $("#cancelar-asignar").show();
            $("#guardar-asignar").hide();
            $("#assignment_id").val(data.id);
            $("#task").val(data.task);
            $("#block").val(data.city_block_id);
            $("#date").val(moment(data.date).format("DD/MM/YYYY HH:mm"));
            $("#status").val(data.status);
            $("#notes").val(data.notes);
            var elt = $("#volunteers");
            for(var v of data.users) {
                var vname;
                if (v.first_name === '' && v.last_name === '') vname = v.name;
                else vname = v.first_name + " " + v.last_name;
                elt.tagsinput('add', { "id": parseInt(v.id), "name": vname, "picture": null });
            }
            enableFields();
        });
    });

    $("#cancelar-asignar").on("click", function() {
        $("#assignment_id").val("");
        $("#editar-asignar").hide();
        $("#cancelar-asignar").hide();
        $("#guardar-asignar").show();
        $("#volunteers").tagsinput("removeAll");
    });
});

function emptyFields() {
    $("input[name!=authenticity_token], textarea").val("");
    $("#volunteers").tagsinput('removeAll');
    $("#block").val($("#block option:first").val());
    $("#status").val('pendiente');
}

function disableFields() {
    $("input, textarea, select").attr("readonly",true);
}
function enableFields() {
    $("input, textarea, select").attr("readonly",false);
}
</script>

<script>
    $(document).ready(function(){
        $('#id_barrio').change(function() {  
            var cuerpo = $("#ultimos_recorrido");
            var obtener_valor  = $(this).val().split("-");
            var id_barrio_nuevo = obtener_valor[0];
            var idciudad = obtener_valor[1];

            if (idciudad == undefined){
                idciudad = $("#id_city").val();
            }
            if(idciudad == 0){
                cuerpo.html("");
            }else{
                //$.get("/organizations/assignments/"+idciudad+"/barrio/"+id_barrio_nuevo, function(data) {
                //   cuerpo.html("");
                //   for (var item of data) {
                //       var fila = cuerpo.append("<tr id='"+item.id+"'/>");
                //      fila.append("<td>"+item.city_block_name+"</td>");
                //      fila.append("<td>"+item.visit_count+"</td>");
                //      fila.append("<td>"+moment(item.last_visit_date).format("DD/MM/YYYY")+"</td>");
                //   }
                //});

                $.get("/organizations/neighborhoodlocation/"+id_barrio_nuevo, function(data) {
                    load_neighborhood(id_barrio_nuevo)
                 mymap.panTo(new L.LatLng(data.latitude, data.longitude));
                });
            }
            
        });
    });
</script>

<script>
    $(document).ready(function(){
        $('#block_barrios_menos').change(function() {  
            var cuerpo = $("#barrios_menos");
            var obtener_valor  = $(this).val().split("-");
            var id_barrio_nuevo = obtener_valor[0];
            var idciudad = obtener_valor[1];
            if (idciudad == undefined){
                idciudad = $("#id_city").val();
            }
            if(idciudad == 0){
                cuerpo.html("");
            }else{
                $.get("/organizations/assignments/"+idciudad+"/barriomenos/"+id_barrio_nuevo, function(data) {
                    cuerpo.html("");
                    for (var item of data) {
                        var fila = cuerpo.append("<tr id='"+item.id+"'/>");
                        fila.append("<td>"+item.city_block_name+"</td>");
                        fila.append("<td>"+item.visit_count+"</td>");
                        fila.append("<td>"+moment(item.last_visit_date).format("DD/MM/YYYY")+"</td>");
                    }
                });
            }
        });
    });
</script>
 

<script>
    $(document).ready(function(){

        $('#id_city').change(function() {  
            var cuerpo_select1 = $("#id_barrio");
            var cuerpo_ultimos = $("#ultimos_recorrido");
            //var cuerpo_menos = $("#barrios_menos");
            //var cuerpo_select2 = $(block_barrios_menos);
            $.get("/organizations/assignments/cityselect/"+$(this).val(), function(data) {
                cuerpo_select1.html("");
                //cuerpo_select2.html("");
                cuerpo_ultimos.html("");
                //cuerpo_menos.html("");
                var fila1 = cuerpo_select1.append("<option value='0-0' Seleccione/>");
                //var fila2 = cuerpo_select2.append("<option value='0-0' Seleccione/>");
                if(data != null){
                    for (var item of data) {
                        fila1.append("<option value = "+item.id+" > "+item.name+"</option>");
                        //fila2.append("<option value = "+item.id+"-"+item.city_id+" > "+item.name+"</option>");
                    }
                }
                
            });

            $.get("/organizations/citymap/"+$(this).val(), function(data) {
                console.log("Got new map: "+data);
                // var map = $("#citymap");
                // map.html("");
                if (data !=null && data[0] !=null) {
                   // var map_url=data[0].value
                   // map.append("<iframe src=\""+map_url+"\" width=\"100%\" height=\"640\"></iframe>");
                } else {
                    // map.append("<h2>No existe mapa para la ciudad del usuario</h2>");
                }
            });
        });
    });
</script>





    <script>

function perc2color(a, b) {
    console.log(a)
    console.log(b)
    if( a == 0  && b==0 ) return '#c2c2c2';
    perc =  a/b;
    perc  =  perc *100;
	var r, g, b = 0;
	if(perc < 50) {
		r = 255;
		g = Math.round(5.1 * perc);
	}
	else {
		g = 255;
		r = Math.round(510 - 5.10 * perc);
	}
	var h = r * 0x10000 + g * 0x100 + b * 0x1;
	return '#' + ('000000' + h.toString(16)).slice(-6);
}




function abrir_asignar_popup(id, name){

    $("#block-title").html(name)
    $("#block-data").val(id)
    $('#asignar-popup').modal('show');
}


function mostrar_asignaciones_popup(id, name){
   
    let xhr = new XMLHttpRequest();
    xhr.open('GET', '/organizations/cityblockassigns/'+id);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'json';
    xhr.onload = function() {
        if (xhr.status !== 200) return

        if(xhr.response.length == 0){
            $('#message-popup').modal('show');
            return 
        }
        
        var container = document.getElementById('assignment-container');
        container.innerHTML = "";
        console.log(container)
        for (let i = 0; i < xhr.response.length; i++) {
            const element = xhr.response[i];
            container_tr =  document.createElement('tr')

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.id)  )
            container_tr.appendChild(container_td)

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.task)  )
            container_tr.appendChild(container_td)

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.date)  )
            container_tr.appendChild(container_td)

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.status)  )
            container_tr.appendChild(container_td)

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.date)  )
            container_tr.appendChild(container_td)

            container_td =  document.createElement('td')
            container_td.appendChild(document.createTextNode(element.notes)  )
            container_tr.appendChild(container_td)

  

            container.appendChild(container_tr)


        }
        $('#list-popup').modal('show');

        /*
        "id": 5,
        "task": "test actividad",
        "city_block_id": 81,
        "date": "2019-08-16T14:20:00.000-04:00",
        "status": "pendiente",
        "notes": "ninguna observacion",
        "created_at": "2019-08-16T11:21:14.473-04:00",
        "updated_at": "2019-08-16T11:21:14.473-04:00"
      }*/
      

    }
    xhr.send();
}
</script>


<% content_for :head do %>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>
    <style>
    #mapid { height: 600px; }
</style>

    <% end %>





    <!-- <div class="panel panel-default assignments">
    <h2>Últimos recorridos</h2>
        <div id= "barrios_select" class="form-group">
            <label>Seleccione el barrio</label>
            <%= select_tag "id_barrio", content_tag(:option,'',:value=>"0-0"), class: "form-control"%>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Manzana</th>
                    <th>Visitas</th>
                    <th>Última visita</th>
                </tr>
            </thead>
            <tbody id="ultimos_recorrido">
            </tbody>
        </table>
</div>
<div class="panel panel-default assignments">
    <h2>Manzanas menos recorridas</h2>
    <div class="form-group">
        <label>Seleccione el barrio</label>
        <%= select_tag "block_barrios_menos", content_tag(:option,'',:value=>"0-0"), class: "form-control" %>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>Manzana</th>
                <th>Visitas</th>
                <th>Última visita</th>
            </tr>
        </thead>
        <tbody id="barrios_menos">
        </tbody>
    </table>
</div>

-->